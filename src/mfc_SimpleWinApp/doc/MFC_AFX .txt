# 🏗️ MFC 整体架构概览

┌─────────────────────────────────────────────────────────────┐
│                    MFC 框架核心架构                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │   CObject 基类  │  │  运行时类型系统 │  │ 线程本地存储│  │  
│  │                 │  │                 │  │             │  │
│  │ - RTTI 支持     │  │ - 动态创建      │  │ - TLS管理   │  │
│  │ - 序列化基础    │◄─┼─│ - 类型检查    │◄─┼─│ - 线程状态│  │
│  │ - 反射机制      │  │ - 类信息维护    │  │ - 模块状态  │  │
│  └─────────────────┘  └─────────────────┘  └─────────────┘  │
│         ▲                          ▲              ▲         │
│         │                          │              │         │
│  ┌──────┴──────┐           ┌───────┴──────┐       │         │
│  │             │           │              │       │         │
│  │ CWinThread  │           │ CWinApp      │       │         │
│  │             │           │              │       │         │
│  │ - 线程管理  │◄──────────│ - 应用程序   │       │         │
│  │ - 消息循环  │           │ - 主窗口管理 │       │         │
│  │ - 空闲处理  │           │ - 资源管理   │       │         │
│  └─────────────┘           └──────────────┘       │         │
│                                                   │         │
│  ┌────────────────────────────────────────────────┘         │
│  │                                                          │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │  │ 窗口系统    │  │ 消息系统    │  │ 资源系统    │       │
│  │  │             │  │             │  │             │       │
│  │  │ - CWnd      │  │ - 消息泵    │  │ - 图标      │       │
│  │  │ - 控件      │  │ - 预处理    │  │ - 光标      │       │
│  │  │ - 对话框    │  │ - 分发      │  │ - 字符串    │       │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │
│  │                                                          │
└─────────────────────────────────────────────────────────────┘


## 🔄 运行时类型系统 (RTTI)

CRuntimeClass 结构
┌─────────────────────────────────────────────────┐
│              CRuntimeClass                       │
├─────────────────────────────────────────────────┤
│ - m_lpszClassName: LPCSTR      (类名)           │
│ - m_nObjectSize: int           (对象大小)       │
│ - m_wSchema: UINT              (版本号)         │
│ - m_pfnCreateObject: function  (创建函数)       │
│ - m_pBaseClass: CRuntimeClass* (基类指针)       │
│ - m_pNextClass: CRuntimeClass* (链表下一个)     │
├─────────────────────────────────────────────────┤
│ + CreateObject(): CObject*                      │
│ + IsDerivedFrom(): BOOL        (继承检查)       │
└─────────────────────────────────────────────────┘

宏系统工作原理
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ DECLARE_DYNAMIC │ -> │ IMPLEMENT_      │ -> │ RUNTIME_CLASS   │
│                 │    │ RUNTIMECLASS    │    │                 │
│ - 声明静态成员  │    │ - 定义静态成员  │    │ - 获取类信息    │
│ - 声明虚函数    │    │ - 实现虚函数    │    │ - 类型转换      │
└─────────────────┘    └─────────────────┘    └─────────────────┘


## 🧵 线程本地存储架构
### TLS 管理系统
┌─────────────────────────────────────────────────────────┐
│                 CThreadSlotData                         │
├─────────────────────────────────────────────────────────┤
│ - m_tlsIndex: DWORD                    (TLS索引)        │
│ - m_nAlloc: int                        (分配槽位数)     │
│ - m_nRover: int                        (空闲槽位搜索)   │
│ - m_pSlotData: CSlotData*              (槽位数据数组)   │
│ - m_list: CTypedSimpleList<CThreadData*> (线程数据链表) │
│ - m_cs: CRITICAL_SECTION               (线程同步)       │
├─────────────────────────────────────────────────────────┤
│ + AllocSlot(): int                     (分配槽位)       │
│ + FreeSlot(int): void                  (释放槽位)       │
│ + GetThreadValue(int): void*           (获取线程值)     │
│ + SetValue(int, void*): void           (设置线程值)     │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ CThreadLocal    │    │ CThreadData     │    │ CSlotData       │
│                 │    │                 │    │                 │
│ - m_nSlot       │    │ - pNext         │    │ - dwFlags       │
│ + GetData()     │    │ - nCount        │    │ - hInst         │
│ + operator->()  │    │ - pData[]       │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘

## 📊 状态管理系统
### 模块和线程状态
┌─────────────────────────────────────────────────────────┐
│                AFX_MODULE_STATE                         │
├─────────────────────────────────────────────────────────┤
│ - m_listClass: CTypedSimpleList<CRuntimeClass*>         │
│ - m_pCurrentWinApp: CWinApp*                            │
│ - m_hCurrentInstanceHandle: HINSTANCE                   │
│ - m_hCurrentResourceHandle: HINSTANCE                   │
│ - m_thread: THREAD_LOCAL(AFX_MODULE_THREAD_STATE)       │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│            AFX_MODULE_THREAD_STATE                      │
├─────────────────────────────────────────────────────────┤
│ - m_pCurrentWinThread: CWinThread*                      │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│                _AFX_THREAD_STATE                        │
├─────────────────────────────────────────────────────────┤
│ - m_pModuleState: AFX_MODULE_STATE*                     │
│ - m_szTempClassName: TCHAR[96]                          │
│ - m_pWndInit: CWnd*                                     │
│ - m_hHookOldCbtFilter: HHOOK                            │
│ - m_lastSendMsg: MSG                                    │
└─────────────────────────────────────────────────────────┘

## 🚀 应用程序执行流程

### MFC 应用程序启动序列
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   wWinMain      │ -> │  AfxWinInit     │ -> │ InitApplication │
│   (OS入口)      │    │ (Windows初始化) │    │ (应用初始化)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ InitInstance    │ -> │     Run         │ -> │  ExitInstance   │
│ (实例初始化)    │    │  (消息循环)     │    │ (退出清理)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘

### 消息循环详细流程
┌─────────────────────────────────────────────────────────┐
│                 CWinThread::Run()                       │
├─────────────────────────────────────────────────────────┤
│  循环开始                                               │
│    ↓                                                    │
│  ┌─空闲处理阶段─────────────────────────────────────┐   │
│  │ while (bIdle && 无消息)                          │   │
│  │   ↓                                              │   │
│  │  调用 OnIdle(lIdleCount++)                       │   │
│  │   ↓                                              │   │
│  │  如果返回 FALSE → bIdle = FALSE                  │   │
│  └──────────────────────────────────────────────────┘   │
│    ↓                                                    │
│  ┌─消息处理阶段─────────────────────────────────────┐   │
│  │ do                                               │   │
│  │   ↓                                              │   │
│  │  调用 PumpMessage()                              │   │
│  │   ↓                                              │   │
│  │  如果返回 FALSE → 退出应用程序                   │   │
│  │   ↓                                              │   │
│  │  如果是空闲消息 → bIdle = TRUE                   │   │
│  │ while (还有消息)                                 │   │
│  └──────────────────────────────────────────────────┘   │
│    ↓                                                    │
│  循环继续                                               │
└─────────────────────────────────────────────────────────┘

## 🔧 核心组件关系
### 类继承体系
┌─────────────────┐
│    CObject      │  (基类)
│                 │
│ + RTTI支持      │
│ + 动态创建      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   CWinThread    │  (线程管理)
│                 │
│ + 消息循环      │
│ + 空闲处理      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    CWinApp      │  (应用程序)
│                 │
│ + 资源管理      │
│ + 窗口管理      │
└─────────────────┘

### 线程创建流程
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ AfxBeginThread  │ -> │ CreateThread    │ -> │ _AfxThreadEntry │
│ (创建线程)      │    │ (创建系统线程)  │    │ (线程入口点)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│ 设置线程状态    │ -> │ 调用用户函数     │ -> │ AfxEndThread    │
│ (TLS初始化)     │    │ (m_pfnThreadProc)│    │ (线程退出)      │
└─────────────────┘    └──────────────────┘    └─────────────────┘


## 总结
### 设计模式应用
1. 模板方法模式 - CWinThread::Run() 定义算法骨架

2.工厂模式 - CRuntimeClass::CreateObject() 动态创建

3.单例模式 - AfxGetApp() 获取应用实例

4.观察者模式 - 消息分发机制

5.策略模式 - 可替换的消息预处理

这个架构展示了 MFC 框架如何通过 RTTI 和 TLS 实现类型安全、线程安全和动态创建的核心机制。